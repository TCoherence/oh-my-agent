# v0.5 Runtime Plan / v0.5 è¿è¡Œæ—¶è®¡åˆ’

> Updated through current v0.5.x baseline: merge gate + external runtime workspace + janitor cleanup + transient short-workspace TTL + optional LLM routing + runtime observability.

> å½“å‰æ–‡æ¡£å·²å¯¹é½åˆ° v0.5.x æœ€æ–°åŸºçº¿ï¼šmerge gateã€å¤–ç½® runtime workspaceã€janitor cleanupã€çŸ­å¯¹è¯ä¸´æ—¶ workspace TTLã€å¯é€‰ LLM è·¯ç”±ï¼Œä»¥åŠ runtime å¯è§‚æµ‹æ€§ã€‚

## Goal / ç›®æ ‡

Build a durable autonomous task runtime so the bot can continue long coding loops without waiting for user messages at every step.

æ„å»ºå¯æŒä¹…åŒ–çš„è‡ªä¸»ä»»åŠ¡è¿è¡Œæ—¶ï¼Œä½¿ bot å¯ä»¥åœ¨é•¿ä»»åŠ¡ä¸­æŒç»­å¾ªç¯ï¼Œè€Œä¸æ˜¯æ¯ä¸€æ­¥éƒ½ç­‰å¾…ç”¨æˆ·è¾“å…¥ã€‚

## Runtime Model / è¿è¡Œæ¨¡å‹

- Task states:
  - `DRAFT`
  - `PENDING`
  - `RUNNING`
  - `VALIDATING`
  - `APPLIED`
  - `WAITING_MERGE`
  - `MERGED`
  - `MERGE_FAILED`
  - `DISCARDED`
  - `BLOCKED`
  - `FAILED`
  - `TIMEOUT`
  - `STOPPED`
  - `REJECTED`
- SQLite runtime tables:
  - `runtime_tasks`
  - `runtime_task_checkpoints`
  - `runtime_task_events`
  - `runtime_task_decisions`
- On restart, inflight tasks (`RUNNING` / `VALIDATING`) are re-queued to `PENDING`.

## Entry Points / ä»»åŠ¡å…¥å£

1. Message intent (`fix/implement/run tests/...`) can auto-create runtime tasks.
   æ¶ˆæ¯æ„å›¾ï¼ˆå¦‚ `fix/implement/run tests/...`ï¼‰å¯è‡ªåŠ¨åˆ›å»º runtime taskã€‚
2. Scheduler jobs can enqueue runtime tasks.
   scheduler ä»»åŠ¡å¯ä»¥åˆ›å»º runtime taskã€‚
3. Slash command `/task_start` creates tasks explicitly.
   slash å‘½ä»¤ `/task_start` å¯æ˜¾å¼åˆ›å»ºä»»åŠ¡ã€‚
4. Optional LLM router can propose a runtime task before heuristic intent checks; execution still requires human confirmation when configured.
   å¯é€‰ LLM è·¯ç”±å™¨å¯åœ¨å¯å‘å¼æ„å›¾åˆ¤æ–­ä¹‹å‰å…ˆæè®® runtime taskï¼›è‹¥å¯ç”¨äº†äººå·¥ç¡®è®¤ï¼Œä»éœ€å…ˆç¡®è®¤å†æ‰§è¡Œã€‚

## Risk Gating / é£é™©åˆ†æµ

Default profile is `strict`.

Low-risk tasks auto-run only when all constraints hold:

- no sensitive keywords (`pip install`, `.env`, `config.yaml`, deploy/migration hints)
- budget within defaults (`<=8 steps`, `<=20 minutes`)
- path policy remains enforceable

Otherwise task starts in `DRAFT` and requires approval.

## Decision Surface / å®¡æ‰¹äº¤äº’

- Primary: Discord buttons (`Approve`, `Reject`, `Suggest`, `Merge`, `Discard`, `Request Changes`)
- Fallback: slash commands (`/task_approve`, `/task_reject`, `/task_suggest`, `/task_merge`, `/task_discard`)
- Decision nonce (`tdec:<task_id>:<action>:<nonce8>`) is one-time and expires by TTL.
- Reactions are status-only signals (`â³`, `ğŸ‘€`, `ğŸ§ª`, `âœ…`, `âš ï¸`, `ğŸ—‘ï¸`), not decision actions.
- Status updates should prefer editing a single runtime status message instead of spamming multiple messages.
- runtime çŠ¶æ€æ›´æ–°åº”ä¼˜å…ˆå¤ç”¨å¹¶ç¼–è¾‘å•æ¡çŠ¶æ€æ¶ˆæ¯ï¼Œè€Œä¸æ˜¯ä¸æ–­åˆ·å‡ºå¤šæ¡æ¶ˆæ¯ã€‚

## Loop Contract / å¾ªç¯åè®®

Each step:

1. Build runtime prompt with goal, step index, prior failure, resume instruction.
2. Run agent in per-task git worktree (`~/.oh-my-agent/runtime/tasks/<task_id>`).
3. Validate changed paths using `allow_all_with_denylist` policy.
4. Run configured test command.
5. Persist checkpoint and event.
   æŒä¹…åŒ– checkpoint å’Œäº‹ä»¶ã€‚
6. Transition state:
   - pass + `TASK_STATE: DONE` -> `WAITING_MERGE`
   - `TASK_STATE: BLOCKED` -> `BLOCKED`
   - budget exceeded -> `TIMEOUT`
   - unrecoverable error -> `FAILED`
   - otherwise continue.
7. Merge gate:
   - `WAITING_MERGE` + Merge -> `MERGED`
   - `WAITING_MERGE` + Discard -> `DISCARDED`
   - merge guard/apply failure -> `MERGE_FAILED`

## Observability / å¯è§‚æµ‹æ€§

- `/task_logs` exposes recent runtime events plus last agent/test output tail.
- `/task_logs` å¯æŸ¥çœ‹æœ€è¿‘ runtime äº‹ä»¶å’Œæœ€è¿‘ä¸€æ¬¡ agent/test è¾“å‡º tailã€‚
- Full heartbeat information is kept in process logs.
- å…¨é‡ heartbeat ä¿¡æ¯ä¿ç•™åœ¨è¿›ç¨‹æ—¥å¿—ä¸­ã€‚
- SQLite stores sampled progress events (`task.agent_progress`, `task.test_progress`) rather than every heartbeat.
- SQLite ä»…ä¿å­˜é‡‡æ ·åçš„ progress äº‹ä»¶ï¼ˆ`task.agent_progress`, `task.test_progress`ï¼‰ï¼Œè€Œä¸æ˜¯æ¯ä¸€æ¬¡ heartbeatã€‚
- Discord runtime progress should be surfaced through a single updatable status message whenever possible.
- Discord çš„ runtime è¿›åº¦åº”å°½é‡é€šè¿‡ä¸€æ¡å¯æ›´æ–°çš„çŠ¶æ€æ¶ˆæ¯å±•ç¤ºã€‚

## Slash Commands / å‘½ä»¤

- `/task_start`
- `/task_status`
- `/task_list`
- `/task_approve`
- `/task_reject`
- `/task_suggest`
- `/task_resume`
- `/task_stop`
- `/task_merge`
- `/task_discard`
- `/task_changes`
- `/task_logs`
- `/task_cleanup`

## Security Defaults / å®‰å…¨é»˜è®¤å€¼

- task control/decision commands are owner-only
- denied paths include `.env`, `config.yaml`, `.workspace/**`, `.git/**`
- dual budget guard (steps + time)
- merge guard: clean repo + `git apply --check` preflight
- runtime artifacts default outside repo under `~/.oh-my-agent/runtime/`

## Validation Checklist / éªŒæ”¶æ¸…å•

- At least one real coding loop reaches `WAITING_MERGE` and then `MERGED`.
- Button decision path and slash fallback both work.
- `BLOCKED` / `FAILED` / `TIMEOUT` statuses are observable and persisted.
- `/task_logs` should make it possible to tell whether execution is stuck in agent phase or test phase.
- `/task_logs` åº”èƒ½å¸®åŠ©åˆ¤æ–­ä»»åŠ¡æ˜¯å¡åœ¨ agent é˜¶æ®µè¿˜æ˜¯ test é˜¶æ®µã€‚
- Existing `/ask`, `/search`, scheduler behavior remains functional.

## Known Gaps / å·²çŸ¥ç¼ºå£

- Runtime stop/resume is not yet message-driven.
- runtime çš„ stop/resume è¿˜æ²¡æœ‰é€šè¿‡è‡ªç„¶è¯­è¨€æ¶ˆæ¯æ¥å…¥ã€‚
- Current `stop` semantics are not yet a hard interrupt of the active subprocess.
- å½“å‰ `stop` è¿˜ä¸ç­‰äºå¯¹æ´»è·ƒå­è¿›ç¨‹çš„å¼ºåˆ¶ä¸­æ–­ã€‚
- Skill generation is not yet a first-class runtime task type.
- skill ç”Ÿæˆè¿˜ä¸æ˜¯ä¸€ç±»ä¸€ç­‰çš„ runtime taskã€‚
