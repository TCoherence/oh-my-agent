# v0.5 Runtime Plan / v0.5 è¿è¡Œæ—¶è®¡åˆ’

> Updated in v0.5.2: merge gate + external runtime workspace + janitor cleanup.

## Goal / ç›®æ ‡

Build a durable autonomous task runtime so the bot can continue long coding loops without waiting for user messages at every step.

æ„å»ºå¯æŒä¹…åŒ–çš„è‡ªä¸»ä»»åŠ¡è¿è¡Œæ—¶ï¼Œä½¿ bot å¯ä»¥åœ¨é•¿ä»»åŠ¡ä¸­æŒç»­å¾ªç¯ï¼Œè€Œä¸æ˜¯æ¯ä¸€æ­¥éƒ½ç­‰å¾…ç”¨æˆ·è¾“å…¥ã€‚

## Runtime Model / è¿è¡Œæ¨¡å‹

- Task states:
  - `DRAFT`
  - `PENDING`
  - `RUNNING`
  - `VALIDATING`
  - `APPLIED`
  - `WAITING_MERGE`
  - `MERGED`
  - `MERGE_FAILED`
  - `DISCARDED`
  - `BLOCKED`
  - `FAILED`
  - `TIMEOUT`
  - `STOPPED`
  - `REJECTED`
- SQLite runtime tables:
  - `runtime_tasks`
  - `runtime_task_checkpoints`
  - `runtime_task_events`
  - `runtime_task_decisions`
- On restart, inflight tasks (`RUNNING` / `VALIDATING`) are re-queued to `PENDING`.

## Entry Points / ä»»åŠ¡å…¥å£

1. Message intent (`fix/implement/run tests/...`) can auto-create runtime tasks.
2. Scheduler jobs can enqueue runtime tasks.
3. Slash command `/task_start` creates tasks explicitly.

## Risk Gating / é£é™©åˆ†æµ

Default profile is `strict`.

Low-risk tasks auto-run only when all constraints hold:

- no sensitive keywords (`pip install`, `.env`, `config.yaml`, deploy/migration hints)
- budget within defaults (`<=8 steps`, `<=20 minutes`)
- path policy remains enforceable

Otherwise task starts in `DRAFT` and requires approval.

## Decision Surface / å®¡æ‰¹äº¤äº’

- Primary: Discord buttons (`Approve`, `Reject`, `Suggest`, `Merge`, `Discard`, `Request Changes`)
- Fallback: slash commands (`/task_approve`, `/task_reject`, `/task_suggest`, `/task_merge`, `/task_discard`)
- Decision nonce (`tdec:<task_id>:<action>:<nonce8>`) is one-time and expires by TTL.
- Reactions are status-only signals (`â³`, `ğŸ‘€`, `ğŸ§ª`, `âœ…`, `âš ï¸`, `ğŸ—‘ï¸`), not decision actions.

## Loop Contract / å¾ªç¯åè®®

Each step:

1. Build runtime prompt with goal, step index, prior failure, resume instruction.
2. Run agent in per-task git worktree (`~/.oh-my-agent/runtime/tasks/<task_id>`).
3. Validate changed paths using `allow_all_with_denylist` policy.
4. Run configured test command.
5. Persist checkpoint and event.
6. Transition state:
   - pass + `TASK_STATE: DONE` -> `WAITING_MERGE`
   - `TASK_STATE: BLOCKED` -> `BLOCKED`
   - budget exceeded -> `TIMEOUT`
   - unrecoverable error -> `FAILED`
   - otherwise continue.
7. Merge gate:
   - `WAITING_MERGE` + Merge -> `MERGED`
   - `WAITING_MERGE` + Discard -> `DISCARDED`
   - merge guard/apply failure -> `MERGE_FAILED`

## Slash Commands / å‘½ä»¤

- `/task_start`
- `/task_status`
- `/task_list`
- `/task_approve`
- `/task_reject`
- `/task_suggest`
- `/task_resume`
- `/task_stop`
- `/task_merge`
- `/task_discard`
- `/task_changes`
- `/task_cleanup`

## Security Defaults / å®‰å…¨é»˜è®¤å€¼

- task control/decision commands are owner-only
- denied paths include `.env`, `config.yaml`, `.workspace/**`, `.git/**`
- dual budget guard (steps + time)
- merge guard: clean repo + `git apply --check` preflight
- runtime artifacts default outside repo under `~/.oh-my-agent/runtime/`

## Validation Checklist / éªŒæ”¶æ¸…å•

- At least one real coding loop reaches `WAITING_MERGE` and then `MERGED`.
- Button decision path and slash fallback both work.
- `BLOCKED` / `FAILED` / `TIMEOUT` statuses are observable and persisted.
- Existing `/ask`, `/search`, scheduler behavior remains functional.
